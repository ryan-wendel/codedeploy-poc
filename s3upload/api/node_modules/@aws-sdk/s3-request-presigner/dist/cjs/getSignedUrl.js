"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getSignedUrl = void 0;
const protocol_http_1 = require("@aws-sdk/protocol-http");
const util_format_url_1 = require("@aws-sdk/util-format-url");
const presigner_1 = require("./presigner");
const getSignedUrl = async (client, command, options = {}) => {
    const s3Presigner = new presigner_1.S3RequestPresigner({ ...client.config });
    const presignInterceptMiddleware = (next, context) => async (args) => {
        var _a, _b;
        const { request } = args;
        if (!protocol_http_1.HttpRequest.isInstance(request)) {
            throw new Error("Request to be presigned is not an valid HTTP request.");
        }
        // Retry information headers are not meaningful in presigned URLs
        delete request.headers["amz-sdk-invocation-id"];
        delete request.headers["amz-sdk-request"];
        const presigned = await s3Presigner.presign(request, {
            ...options,
            signingRegion: (_a = options.signingRegion) !== null && _a !== void 0 ? _a : context["signing_region"],
            signingService: (_b = options.signingService) !== null && _b !== void 0 ? _b : context["signing_service"],
        });
        return {
            // Intercept the middleware stack by returning fake response
            response: {},
            output: {
                $metadata: { httpStatusCode: 200 },
                presigned,
            },
        };
    };
    const middlewareName = "presignInterceptMiddleware";
    try {
        client.middlewareStack.addRelativeTo(presignInterceptMiddleware, {
            name: middlewareName,
            relation: "before",
            toMiddleware: "awsAuthMiddleware",
        });
    }
    catch (e) {
        if (e.message.includes(`Duplicated middleware name '${middlewareName}'`)) {
            // Swallow if the interceptor is already added. See https://github.com/aws/aws-sdk-js-v3/issues/1857
        }
        else {
            throw e;
        }
    }
    let presigned;
    try {
        const output = await client.send(command);
        //@ts-ignore the output is faked, so it's not actually OutputType
        presigned = output.presigned;
    }
    finally {
        client.middlewareStack.remove(middlewareName);
    }
    return util_format_url_1.formatUrl(presigned);
};
exports.getSignedUrl = getSignedUrl;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0U2lnbmVkVXJsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2dldFNpZ25lZFVybC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwwREFBcUQ7QUFHckQsOERBQXFEO0FBRXJELDJDQUFpRDtBQUUxQyxNQUFNLFlBQVksR0FBRyxLQUFLLEVBSy9CLE1BQXlELEVBQ3pELE9BQTZFLEVBQzdFLFVBQXNDLEVBQUUsRUFDdkIsRUFBRTtJQUNuQixNQUFNLFdBQVcsR0FBRyxJQUFJLDhCQUFrQixDQUFDLEVBQUUsR0FBRyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztJQUNqRSxNQUFNLDBCQUEwQixHQUFxRCxDQUFDLElBQUksRUFBRSxPQUFPLEVBQUUsRUFBRSxDQUFDLEtBQUssRUFDM0csSUFBSSxFQUNKLEVBQUU7O1FBQ0YsTUFBTSxFQUFFLE9BQU8sRUFBRSxHQUFHLElBQUksQ0FBQztRQUN6QixJQUFJLENBQUMsMkJBQVcsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLEVBQUU7WUFDcEMsTUFBTSxJQUFJLEtBQUssQ0FBQyx1REFBdUQsQ0FBQyxDQUFDO1NBQzFFO1FBQ0QsaUVBQWlFO1FBQ2pFLE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO1FBQ2hELE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBRTFDLE1BQU0sU0FBUyxHQUFHLE1BQU0sV0FBVyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUU7WUFDbkQsR0FBRyxPQUFPO1lBQ1YsYUFBYSxRQUFFLE9BQU8sQ0FBQyxhQUFhLG1DQUFJLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQztZQUNqRSxjQUFjLFFBQUUsT0FBTyxDQUFDLGNBQWMsbUNBQUksT0FBTyxDQUFDLGlCQUFpQixDQUFDO1NBQ3JFLENBQUMsQ0FBQztRQUNILE9BQU87WUFDTCw0REFBNEQ7WUFDNUQsUUFBUSxFQUFFLEVBQUU7WUFDWixNQUFNLEVBQUU7Z0JBQ04sU0FBUyxFQUFFLEVBQUUsY0FBYyxFQUFFLEdBQUcsRUFBRTtnQkFDbEMsU0FBUzthQUNWO1NBQ0ssQ0FBQztJQUNYLENBQUMsQ0FBQztJQUNGLE1BQU0sY0FBYyxHQUFHLDRCQUE0QixDQUFDO0lBQ3BELElBQUk7UUFDRixNQUFNLENBQUMsZUFBZSxDQUFDLGFBQWEsQ0FBQywwQkFBMEIsRUFBRTtZQUMvRCxJQUFJLEVBQUUsY0FBYztZQUNwQixRQUFRLEVBQUUsUUFBUTtZQUNsQixZQUFZLEVBQUUsbUJBQW1CO1NBQ2xDLENBQUMsQ0FBQztLQUNKO0lBQUMsT0FBTyxDQUFDLEVBQUU7UUFDVixJQUFJLENBQUMsQ0FBQyxPQUFRLENBQUMsUUFBUSxDQUFDLCtCQUErQixjQUFjLEdBQUcsQ0FBQyxFQUFFO1lBQ3pFLG9HQUFvRztTQUNyRzthQUFNO1lBQ0wsTUFBTSxDQUFDLENBQUM7U0FDVDtLQUNGO0lBRUQsSUFBSSxTQUFzQixDQUFDO0lBQzNCLElBQUk7UUFDRixNQUFNLE1BQU0sR0FBRyxNQUFNLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDMUMsaUVBQWlFO1FBQ2pFLFNBQVMsR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDO0tBQzlCO1lBQVM7UUFDUixNQUFNLENBQUMsZUFBZSxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUMsQ0FBQztLQUMvQztJQUVELE9BQU8sMkJBQVMsQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUM5QixDQUFDLENBQUM7QUE1RFcsUUFBQSxZQUFZLGdCQTREdkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBIdHRwUmVxdWVzdCB9IGZyb20gXCJAYXdzLXNkay9wcm90b2NvbC1odHRwXCI7XG5pbXBvcnQgeyBDbGllbnQsIENvbW1hbmQgfSBmcm9tIFwiQGF3cy1zZGsvc21pdGh5LWNsaWVudFwiO1xuaW1wb3J0IHsgQnVpbGRNaWRkbGV3YXJlLCBNZXRhZGF0YUJlYXJlciwgUmVxdWVzdFByZXNpZ25pbmdBcmd1bWVudHMgfSBmcm9tIFwiQGF3cy1zZGsvdHlwZXNcIjtcbmltcG9ydCB7IGZvcm1hdFVybCB9IGZyb20gXCJAYXdzLXNkay91dGlsLWZvcm1hdC11cmxcIjtcblxuaW1wb3J0IHsgUzNSZXF1ZXN0UHJlc2lnbmVyIH0gZnJvbSBcIi4vcHJlc2lnbmVyXCI7XG5cbmV4cG9ydCBjb25zdCBnZXRTaWduZWRVcmwgPSBhc3luYyA8XG4gIElucHV0VHlwZXNVbmlvbiBleHRlbmRzIG9iamVjdCxcbiAgSW5wdXRUeXBlIGV4dGVuZHMgSW5wdXRUeXBlc1VuaW9uLFxuICBPdXRwdXRUeXBlIGV4dGVuZHMgTWV0YWRhdGFCZWFyZXIgPSBNZXRhZGF0YUJlYXJlclxuPihcbiAgY2xpZW50OiBDbGllbnQ8YW55LCBJbnB1dFR5cGVzVW5pb24sIE1ldGFkYXRhQmVhcmVyLCBhbnk+LFxuICBjb21tYW5kOiBDb21tYW5kPElucHV0VHlwZSwgT3V0cHV0VHlwZSwgYW55LCBJbnB1dFR5cGVzVW5pb24sIE1ldGFkYXRhQmVhcmVyPixcbiAgb3B0aW9uczogUmVxdWVzdFByZXNpZ25pbmdBcmd1bWVudHMgPSB7fVxuKTogUHJvbWlzZTxzdHJpbmc+ID0+IHtcbiAgY29uc3QgczNQcmVzaWduZXIgPSBuZXcgUzNSZXF1ZXN0UHJlc2lnbmVyKHsgLi4uY2xpZW50LmNvbmZpZyB9KTtcbiAgY29uc3QgcHJlc2lnbkludGVyY2VwdE1pZGRsZXdhcmU6IEJ1aWxkTWlkZGxld2FyZTxJbnB1dFR5cGVzVW5pb24sIE1ldGFkYXRhQmVhcmVyPiA9IChuZXh0LCBjb250ZXh0KSA9PiBhc3luYyAoXG4gICAgYXJnc1xuICApID0+IHtcbiAgICBjb25zdCB7IHJlcXVlc3QgfSA9IGFyZ3M7XG4gICAgaWYgKCFIdHRwUmVxdWVzdC5pc0luc3RhbmNlKHJlcXVlc3QpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJSZXF1ZXN0IHRvIGJlIHByZXNpZ25lZCBpcyBub3QgYW4gdmFsaWQgSFRUUCByZXF1ZXN0LlwiKTtcbiAgICB9XG4gICAgLy8gUmV0cnkgaW5mb3JtYXRpb24gaGVhZGVycyBhcmUgbm90IG1lYW5pbmdmdWwgaW4gcHJlc2lnbmVkIFVSTHNcbiAgICBkZWxldGUgcmVxdWVzdC5oZWFkZXJzW1wiYW16LXNkay1pbnZvY2F0aW9uLWlkXCJdO1xuICAgIGRlbGV0ZSByZXF1ZXN0LmhlYWRlcnNbXCJhbXotc2RrLXJlcXVlc3RcIl07XG5cbiAgICBjb25zdCBwcmVzaWduZWQgPSBhd2FpdCBzM1ByZXNpZ25lci5wcmVzaWduKHJlcXVlc3QsIHtcbiAgICAgIC4uLm9wdGlvbnMsXG4gICAgICBzaWduaW5nUmVnaW9uOiBvcHRpb25zLnNpZ25pbmdSZWdpb24gPz8gY29udGV4dFtcInNpZ25pbmdfcmVnaW9uXCJdLFxuICAgICAgc2lnbmluZ1NlcnZpY2U6IG9wdGlvbnMuc2lnbmluZ1NlcnZpY2UgPz8gY29udGV4dFtcInNpZ25pbmdfc2VydmljZVwiXSxcbiAgICB9KTtcbiAgICByZXR1cm4ge1xuICAgICAgLy8gSW50ZXJjZXB0IHRoZSBtaWRkbGV3YXJlIHN0YWNrIGJ5IHJldHVybmluZyBmYWtlIHJlc3BvbnNlXG4gICAgICByZXNwb25zZToge30sXG4gICAgICBvdXRwdXQ6IHtcbiAgICAgICAgJG1ldGFkYXRhOiB7IGh0dHBTdGF0dXNDb2RlOiAyMDAgfSxcbiAgICAgICAgcHJlc2lnbmVkLFxuICAgICAgfSxcbiAgICB9IGFzIGFueTtcbiAgfTtcbiAgY29uc3QgbWlkZGxld2FyZU5hbWUgPSBcInByZXNpZ25JbnRlcmNlcHRNaWRkbGV3YXJlXCI7XG4gIHRyeSB7XG4gICAgY2xpZW50Lm1pZGRsZXdhcmVTdGFjay5hZGRSZWxhdGl2ZVRvKHByZXNpZ25JbnRlcmNlcHRNaWRkbGV3YXJlLCB7XG4gICAgICBuYW1lOiBtaWRkbGV3YXJlTmFtZSxcbiAgICAgIHJlbGF0aW9uOiBcImJlZm9yZVwiLFxuICAgICAgdG9NaWRkbGV3YXJlOiBcImF3c0F1dGhNaWRkbGV3YXJlXCIsXG4gICAgfSk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBpZiAoZS5tZXNzYWdlIS5pbmNsdWRlcyhgRHVwbGljYXRlZCBtaWRkbGV3YXJlIG5hbWUgJyR7bWlkZGxld2FyZU5hbWV9J2ApKSB7XG4gICAgICAvLyBTd2FsbG93IGlmIHRoZSBpbnRlcmNlcHRvciBpcyBhbHJlYWR5IGFkZGVkLiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2F3cy9hd3Mtc2RrLWpzLXYzL2lzc3Vlcy8xODU3XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IGU7XG4gICAgfVxuICB9XG5cbiAgbGV0IHByZXNpZ25lZDogSHR0cFJlcXVlc3Q7XG4gIHRyeSB7XG4gICAgY29uc3Qgb3V0cHV0ID0gYXdhaXQgY2xpZW50LnNlbmQoY29tbWFuZCk7XG4gICAgLy9AdHMtaWdub3JlIHRoZSBvdXRwdXQgaXMgZmFrZWQsIHNvIGl0J3Mgbm90IGFjdHVhbGx5IE91dHB1dFR5cGVcbiAgICBwcmVzaWduZWQgPSBvdXRwdXQucHJlc2lnbmVkO1xuICB9IGZpbmFsbHkge1xuICAgIGNsaWVudC5taWRkbGV3YXJlU3RhY2sucmVtb3ZlKG1pZGRsZXdhcmVOYW1lKTtcbiAgfVxuXG4gIHJldHVybiBmb3JtYXRVcmwocHJlc2lnbmVkKTtcbn07XG4iXX0=